<%@page import="cn.iscas.nfsplatform.pojo.RunTaskResultBriefModel"%>
<%@page import="net.sf.json.JSONObject"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme() + "://" + request.getServerName() + ":" + request.getServerPort() + path + "/";
	String basePath1 = request.getScheme() + "://" + request.getServerName() + path + "/";
	
	RunTaskResultBriefModel result = (RunTaskResultBriefModel)request.getAttribute("runtaskresult");
	
	//记录这一步的返回url
	String serviceUrl = result.getServiceUrl();
	//记录节点信息
	String serviceName = result.getServiceName();
	String toolName = result.getToolName();
	String choosedfunction = result.getChoosedfunction();
	long currentTaskid = result.getTaskid();
	int userid = result.getUserid();
	int operationType = result.getOperationType();
	
	
	
%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="<%=basePath%>css/bootstrap.css" rel="stylesheet">
<script type="text/javascript" src="<%=basePath%>script/jsPlumb/jquery-1.9.0.js"></script>
<script type="text/javascript" src="<%=basePath%>script/bootstrap.min.js"></script>

<title>tool</title>

<script type="text/javascript">
	var baseUrl = '<%=basePath1%>';
	var dataAddress = '<%=serviceUrl%>';
	var userid = '<%=userid%>';
	
	var serviceName = '<%=serviceName%>';
	var toolName = '<%=toolName%>';
	var choosedFunction = '<%=choosedfunction%>';
	var currentTaskid = '<%=currentTaskid%>';
	var operationType = '<%=operationType%>';
	
	
	function finishCurrentTask(taskid){
		var iframe_src = baseUrl + "finishtask/" + taskid;
		
		$.ajax({
			url : iframe_src,
			type : "POST",
			data:{"userid":userid,"toolName":toolName,"operationType":operationType},
			success : function(data, status) {
				alert("任务结束，后台更新数据结束~");
				window.location.href= baseUrl+"showtasks/"+userid;
			},
			error : function(request, status, error) {
				alert("结束任务失败~");
			}
		});
	}
	
	$(document).ready(function() {
		if(dataAddress == null || dataAddress == "null"){
			alert("服务路径有误或者为空，请参看数据库。");
		}else{
			$("#toolPage").attr("src", dataAddress);
			$("#toolUrl").val("服务路径："+dataAddress);		
			var html = groupGeneretor("获取网页内容");		
			$("#warntext").attr("value",html);
		}
		
		
	});
	
	function groupGeneretor(tool) {
		var operateDes = "";
		if(operationType == 1){
			operateDes = "数据更新类操作";
		}else{
			operateDes = "非数据更新操作";
		}
		
		var html = "当前服务名称："+serviceName+"  当前工具编号："+toolName+"  当前执行函数："+choosedFunction+"   当前任务编号："+currentTaskid+"  操作类型："+operateDes;
		return html;
	}
	
	
	
</script>

</head>
<body>

	<div class="container" style="width: 100%; height: 800px">
		<hr>
		<div style="width: 100%; height: 100px">
			<input type="text" id="warntext" class="btn btn-primary" style="background-color: #FF9933; width: 100%;" value="" />
			<br><br>

			<div>
				<input id="toolUrl" class="form-control" style="width:60%; float: left">
				<input type="button" class="btn btn-primary" value="完成<%=serviceName %>" style="float:right" onclick="finishCurrentTask(<%=currentTaskid %>)" />
			</div>
		</div>

		<div style="width: 100%; height: 900px">
			<iframe id="toolPage" width="100%" src="" height="100%"
				sandbox="allow-same-origin allow-forms allow-scripts"> </iframe>
		</div>


	</div>

</body>
</html>